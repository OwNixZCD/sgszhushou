<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>管宁技能抽取器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            padding: 15px;
            min-height: calc(100vh - 20px);
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        h1, h2 {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
            word-break: break-word;
        }
        
        h1 {
            font-size: 1.6em;
            margin: 10px 0 20px;
        }
        
        .pool-buttons, .card-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .pool-buttons, .card-buttons {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }
        }
        
        button {
            padding: 14px 8px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 0;
            width: 100%;
            touch-action: manipulation;
        }
        
        .pool-btn {
            background: #4CAF50;
            color: white;
            font-size: 15px;
        }
        
        .pool-btn:hover, .pool-btn:active {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .card-btn {
            background: #2196F3;
            color: white;
            font-size: 16px;
            padding: 16px 8px;
        }
        
        .card-btn:disabled {
            background: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .card-btn:hover:not(:disabled), .card-btn:active:not(:disabled) {
            background: #1976D2;
            transform: scale(1.03);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .option-btn {
            display: block;
            width: 100%;
            margin: 8px 0;
            padding: 14px;
            text-align: left;
            background: #f8f9fa;
            border-left: 4px solid #2196F3;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .option-btn:hover, .option-btn:active {
            background: #e3f2fd;
        }
        
        .option-btn:disabled {
            border-left-color: #bdbdbd;
            background: #f5f5f5;
            color: #757575;
            cursor: not-allowed;
        }
        
        .selected-options {
            margin: 15px 0;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .selected-options div {
            margin: 5px 0;
            padding: 5px 10px;
            background: #4CAF50;
            color: white;
            border-radius: 15px;
            display: inline-block;
            margin-right: 8px;
        }
        
        .executed-actions {
            margin: 15px 0;
            padding: 12px;
            background: #fff3cd;
            border-radius: 8px;
            font-size: 14px;
            border: 1px solid #ffeaa7;
        }
        
        .executed-actions div {
            margin: 5px 0;
            padding: 8px;
            background: #fff;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
        }
        
        .characters-list {
            margin: 15px 0;
        }
        
        .character {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #e0e0e0;
        }
        
        .character h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
            text-align: left;
        }
        
        .skill {
            display: inline-block;
            background: #e3f2fd;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 16px;
            cursor: pointer;
            border: 1px solid #bbdefb;
            font-size: 13px;
            white-space: nowrap;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .skill:hover, .skill:active {
            background: #bbdefb;
        }
        
        .skill-modal .modal-content {
            max-width: 600px;
        }
        
        .skill-detail {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            white-space: pre-wrap;
            line-height: 1.5;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
        }
        
        input:focus {
            border-color: #2196F3;
            outline: none;
        }
        
        .skill-choices {
            margin: 15px 0;
        }
        
        .skill-choice {
            padding: 12px 15px;
            margin: 6px 0;
            background: #f8f9fa;
            border-left: 4px solid #4CAF50;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .skill-choice:hover, .skill-choice:active {
            background: #e8f5e9;
            transform: translateX(3px);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 15px;
        }
        
        .pool-manage-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #9C27B0;
            color: white;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }
        
        .pool-manage-btn:hover, .pool-manage-btn:active {
            background: #7b1fa2;
            transform: scale(1.1);
        }
        
        .custom-skill-input {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            flex-direction: column;
        }
        
        @media (min-width: 480px) {
            .custom-skill-input {
                flex-direction: row;
            }
        }
        
        .custom-skill-input input {
            flex: 1;
            min-width: 0;
        }
        
        .skill-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .skill-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .skill-item:last-child {
            border-bottom: none;
        }
        
        .back-btn {
            background: #757575;
            color: white;
            margin-top: 15px;
            width: 100%;
        }
        
        .status-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
            text-align: center;
            border: 1px solid #ffeaa7;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            width: auto;
            padding: 0;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        /* 响应式调整 */
        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            
            h1 {
                font-size: 1.4em;
            }
            
            h2 {
                font-size: 1.2em;
            }
            
            button {
                padding: 12px 6px;
                font-size: 14px;
            }
            
            .card-btn {
                font-size: 15px;
                padding: 14px 6px;
            }
            
            .modal-content {
                padding: 15px;
            }
            
            .option-btn {
                padding: 12px;
                font-size: 13px;
            }
            
            .skill {
                font-size: 12px;
                padding: 5px 10px;
            }
        }
        
        @media (max-width: 320px) {
            .pool-buttons, .card-buttons {
                grid-template-columns: 1fr;
            }
            
            .skill {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面1：技能池选择 -->
        <div id="page1" class="page active">
            <h1>管宁技能抽取器</h1>
            <h2>请选择技能池：</h2>
            <div class="pool-buttons">
                <button class="pool-btn" onclick="selectPool('手杀')">手杀</button>
                <button class="pool-btn" onclick="selectPool('欢乐杀')">欢乐杀</button>
                <button class="pool-btn" onclick="selectPool('一将成名')">一将成名</button>
            </div>
        </div>

        <!-- 页面2：主操作界面 -->
        <div id="page2" class="page">
            <h2>请选择卡牌</h2>
            <div class="card-buttons">
                <button class="card-btn" onclick="selectCard('杀')">杀</button>
                <button class="card-btn" onclick="selectCard('闪')">闪</button>
                <button class="card-btn" onclick="selectCard('桃')">桃</button>
                <button class="card-btn" onclick="selectCard('酒')">酒</button>
            </div>

            <!-- 已执行操作展示 -->
            <div id="executedActions" class="executed-actions"></div>

            <!-- 已获得角色展示 -->
            <div id="charactersList" class="characters-list"></div>
        </div>

        <!-- 选项弹窗 -->
        <div id="optionsModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeOptionsModal()">×</button>
                <h3>选择卡牌：<span id="selectedCardText"></span></h3>
                <div class="selected-options" id="selectedOptionsList"></div>
                <div id="executedActionsInModal"></div>
                <div class="status-info" id="selectionStatus">请选择2个不重复的选项</div>
                <button class="option-btn" id="option1Btn" onclick="selectOption(1)">1. 防止此伤害，从三个技能中抽取一个技能给当前回合角色</button>
                <button class="option-btn" id="option2Btn" onclick="selectOption(2)">2. 减一点体力上限并摸<span id="xValue">0</span>张牌</button>
                <button class="option-btn" id="option3Btn" onclick="selectOption(3)">3. 移除本牌名</button>
            </div>
        </div>

        <!-- 角色名输入弹窗 -->
        <div id="characterModal" class="modal">
            <div class="modal-content">
                <h3>请输入角色名</h3>
                <input type="text" id="characterName" placeholder="输入角色名字" autocomplete="off">
                <div class="action-buttons">
                    <button onclick="confirmCharacter()" style="background: #4CAF50; color: white;">确定</button>
                    <button onclick="closeCharacterModal()" style="background: #757575; color: white;">取消</button>
                </div>
            </div>
        </div>

        <!-- 技能选择弹窗 -->
        <div id="skillsModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeSkillsModal()">×</button>
                <h3>请选择一个技能赋予：<span id="targetCharacter"></span></h3>
                <div id="skillChoices" class="skill-choices"></div>
            </div>
        </div>

        <!-- 技能详情弹窗（查看用） -->
        <div id="skillDetailModal" class="skill-modal modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeSkillDetailModal()">×</button>
                <h3 id="skillTitle"></h3>
                <div class="skill-detail" id="skillDescription"></div>
                <div class="action-buttons">
                    <button onclick="closeSkillDetailModal()" style="background: #757575; color: white;">关闭</button>
                </div>
            </div>
        </div>

        <!-- 技能选择详情弹窗（选择技能时用） -->
        <div id="skillSelectDetailModal" class="skill-modal modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeSkillSelectDetail()">×</button>
                <h3 id="skillSelectTitle"></h3>
                <div class="skill-detail" id="skillSelectDescription"></div>
                <div class="action-buttons">
                    <button onclick="confirmSkill()" style="background: #4CAF50; color: white;">确认</button>
                    <button onclick="closeSkillSelectDetail()" style="background: #757575; color: white;">返回</button>
                </div>
            </div>
        </div>

        <!-- 技能池管理弹窗 -->
        <div id="poolManageModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closePoolManage()">×</button>
                <h3>技能池管理 - <span id="currentPoolName"></span></h3>
                <div class="skill-list" id="allSkillsList"></div>
                <div class="custom-skill-input">
                    <input type="text" id="newSkillInput" placeholder="格式：角色名：技能名/技能描述" autocomplete="off">
                    <button onclick="addCustomSkill()" style="background: #4CAF50; color: white;">添加</button>
                </div>
                <button onclick="closePoolManage()" class="back-btn">关闭</button>
            </div>
        </div>
    </div>

    <!-- 技能池管理按钮 -->
    <button class="pool-manage-btn" onclick="openPoolManage()">+</button>

    <script>
        // 严格按照您提供的技能数据
        const skillPools = {
            "手杀": {
                "界刘备": ["仁德", "出牌阶段每名角色限一次，你可以交给一名其他角色任意张手牌，若你此次给出了本阶段的第二张'仁德'牌，你可以视为使用一张基本牌或普通锦囊牌。"],
                "蒋钦": ["尚义", "出牌阶段限一次，你可以弃置一张牌，令一名有手牌的其他角色观看你的手牌，然后你观看其手牌，并获得其中的一张牌。"],
                "曹冲": ["仁心", "当体力值为1的其他角色受到伤害时，你可以弃置一张装备牌并翻面，防止此伤害。"],
                "孔融": ["礼让", "其他角色的摸牌阶段开始时，若你没有“谦”标记，你可以令其多摸两张牌且你获得“谦”标记（摸牌阶段开始前，若你有“谦”标记，你跳过此阶段并移去“谦”标记），然后你记录该角色直到你移去“谦”标记（你记录的角色的弃牌阶段结束时，若其本阶段弃置过牌，你可以获得其中的至多两张牌）。"],
                "杨彪": ["义争", "出牌阶段限一次，你可以与一名体力值不大于你的角色拼点，若你：赢，其跳过其下个摸牌阶段；没赢，你减1点体力上限。"],
                "界公孙瓒": ["义从", "锁定技，\n1.你计算与其他角色的距离-X（X为你的体力值-1）；\n2.其他角色计算与你的距离+Y（Y为你已损失的体力值-1）。"],
                "张翼": ["执义", "锁定技，一名角色的结束阶段，若你本回合使用或打出过基本牌，你选择一项：1.视为使用任意一张你本回合使用或打出过的基本牌；2.摸一张牌。"],
                "界关羽": ["义绝", "出牌阶段限一次，你可以弃置一张牌，令一名其他角色展示一张手牌，若此牌为：红色，你获得此牌且你可以令其回复1点体力；黑色，其本回合非锁定技失效且不能使用或打出手牌、你使用♥【杀】对其造成的伤害+1。"],
                "太史慈": ["天义", "出牌阶段限一次，你可以与一名其他角色拼点。若你赢，本回合你可多使用一张【杀】使用【杀】无距离限制且可多指定一个自标：若你没赢，本回合你不能使用【杀】。"],
                "陶谦": ["义襄", "每回合限一次，当你成为一名体力值大于你的角色使用牌的目标后，你可以从牌堆中随机获得一张你没有的基本牌。"],
                "星黄忠": ["义释", "当你对其他角色造成伤害时，若其装备区里有牌，你可以令此伤害-1，然后获得该角色装备区里的一张牌。"],
                "诸葛诞": ["举义", "限定技，准备阶段，若你体力上限大于全场角色数，你可以将手牌摸至体力上限，获得技能'崩坏'和'威重'。"],
                "士燮": ["礼下", "锁定技，其他角色的结束阶段，若你不在其攻击范围内，你选择一项：1.摸一张牌；2.令其摸两张牌。选择完成后，其他角色计算与你的距离-1。"],
                "陆绩": ["遗礼", "出牌阶段开始时，你可以失去1点体力或移去1个'橘'，令一名其他角色获得1个'橘'。"],
                "黄月英": ["集智", "当你使用一张普通锦囊牌时，你可以摸一张牌。若此牌为基本牌，你可以弃置此牌，令你本回合的手牌上限+1。"],
                "荀攸": ["智愚", "当你受到伤害后，你可以摸一张牌，并展示所有手牌。若你的手牌颜色均相同，伤害来源弃置一张手牌。"],
                "陈宫": ["智迟", "锁定技，当你于回合外受到伤害后，本回合【杀】和普通锦囊牌对你无效。"],
                "张恭": ["遣信", "出牌阶段限一次，你可以将至多两张手牌随机分配给等量名角色各一张，称为‘信’，然后该角色的下个准备阶段，若其有‘信’，其选择一项:1.令你摸两张牌；2.本回合的手牌上限-2。"],
                "胡金定": ["仁释", "锁定技，当你受到【杀】造成的伤害时，若你已受伤，你防止此伤害，获得此【杀】，然后你减1点体力上限。"],
                "张鲁": ["义舍", "结束阶段，若你没有'米'，你可以摸两张牌，然后将两张牌置于你的武将牌上，称为'米'。"],
                "王甫赵累": ["殉义", "游戏开始时，你将一名其他角色标记为“义”角色（当“义”角色死亡时，你可以将另一名其他角色标记为“义”角色）；当你或“义”角色造成/受到1点伤害后，若受伤角色/伤害来源不为另一方，另一方摸一张牌/弃置一张牌。"],
                "胡班": ["义烈", "锁定技，游戏开始时，你选择一名其他角色。当该角色：受到伤害时，若你没有“烈”标记，你获得等同于伤害值数的“烈”标记并防止此伤害（结束阶段，若你拥有“烈”标记，你摸一张牌并失去X点体力，然后移去所有的“烈”标记，X为“烈”的数量）；对其他角色造成伤害后，你回复1点体力。"],
                "甘夫人": ["智诫", "每轮限一次，一名角色的出牌阶段开始时，你可以展示其一张手牌。每当其于此阶段内使用与此牌类别相同的牌后，其摸一张牌并弃置X张牌（X为本回合其使用此类别牌的次数-1）;此阶段结束时，若其此阶段内以此法获得的牌数大于弃置的牌数，你与其各摸一张牌。"],
                "神鲁肃": ["智盟", "回合结束后，你可以选择一名其他角色，你与其随机平均分配双方手牌（若为奇数则你分配较多张数）。"]
            },
            "欢乐杀": {
                "刘备": ["仁德", "出牌阶段每名角色限一次，你可以交给一名其他角色任意张手牌，若你此次给出了本阶段的第二张'仁德'牌，你可以视为使用一张基本牌或普通锦囊牌。"],
                "曹冲": ["仁心", "当其他角色受到伤害时，若其体力值为1，你可以翻面并弃置一张装备牌，防止此伤害。"],
                "骆统": ["仁政", "锁定技，当一次伤害结算结束后，若此次伤害被减少或防止过，你摸两张牌。"],
                "sp刘备": ["逐义", "每轮每项限一次，你可以于以下时机弃置一张牌并执行对应效果：\n1.当你获得牌后，令一名角色摸两张牌；\n2.当一名角色受到伤害时，防止此伤害；\n3.一名角色回合开始时，令其检索并获得一张基本牌（此牌伤害或回复值+1）。"],
                "孔融": ["争义", "当你或'礼让'角色不以此法受到伤害时，'礼让'角色或你可以转移此伤害给自己，然后摸一张牌。"],
                "太史慈": ["天义", "出牌阶段开始时，你可以选择两项，令你于本回合使用【杀】：1.次数+1；2.造成伤害后回复1点体力；3.无距离限制；4.摸一张牌。当你使用【杀】指定目标时，你可以与其拼点，若你赢，你可以额外指定一个目标。"],
                "诸葛诞": ["举义", "限定技，准备阶段，若你体力上限大于全场角色数，你可以将手牌摸至体力上限，获得技能'崩坏'和'威重'。"],
                "张鲁": ["义舍", "结束阶段，你可以摸两张牌，然后将两张牌置于你的武将牌上，称为'米'。"],
                "谋张秀": ["豪义", "结束阶段，你可以获得本回合进入弃牌堆的未造成伤害的伤害牌，然后你可以将这些牌分配给其他角色。"],
                "蒋钦": ["尚义", "出牌阶段限一次，你可以弃置一张牌并与一名其他角色相互观看手牌，你选择一项：1.获得其手牌中的一张；2.与其交换一张手牌。若获得牌为黑色或交换牌为红色，你摸一张牌。"],
                "陶谦": ["义襄", "锁定技，其他角色的出牌阶段内：1.其使用的第一张牌对你造成伤害时，此伤害-1；2.其使用第二张牌时，若此牌为黑色，对你无效。"],
                "公孙瓒": ["义从", "锁定技，你计算与其他角色的距离-X（X为你体力值）；其他角色计算与你的距离+Y（Y为你已损失体力值）。"],
                "张嫙": ["同礼", "出牌阶段，当你使用牌指定目标后，若你本阶段使用过X张牌（X为你手牌中的花色数），你可以令此牌效果额外执行X次。"],
                "孔融": ["礼让", "游戏开始时或准备阶段，若场上没有'礼让'角色，你可以选择一名其他角色：其于摸牌阶段摸牌数+1，且其弃牌阶段结束时，你可以获得其此阶段弃置的牌。"],
                "陆绩": ["遗礼", "出牌阶段开始时，你可以失去1点体力或移去1个'橘'，令一名其他角色获得1个'橘'。"],
                "黄月英": ["集智", "当你使用锦囊牌时，你可以摸一张牌，若此牌为：基本牌，本回合你的手牌上限+1；装备牌，你可以将此牌置入其他角色的装备区；锦囊牌，本回合你使用【杀】的次数+1。"],
                "陈宫": ["智迟", "锁定技，当你于回合外受到伤害后，本回合防止你受到的伤害，且普通锦囊牌对你无效。"],
                "荀攸": ["智愚", "当你受到伤害后，你可以摸两张牌并弃一张牌，展示所有手牌，若你的手牌颜色均相同，伤害来源将手牌弃至与你手牌数相同。"],
                "神鲁肃": ["智盟", "回合结束后，你可以选择一名其他角色，你与其随机平均分配双方手牌（若为奇数则你分配较多张数）。"],
                "张恭": ["遣信", "出牌阶段限两次，你可以交给一名其他角色一张手牌，称为'信'。其下个准备阶段，若其有'信'，其需令你摸两张牌，否则本回合手牌上限-2。"]
            },
            "一将成名": {
                "刘备": ["仁德", "出牌阶段每名角色限一次，你可以交给一名其他角色任意张手牌，若你此次给出了本阶段的第二张'仁德'牌，你可以视为使用一张基本牌。"],
                "曹冲": ["仁心", "当其他角色受到伤害时，若其体力值为1，你可以翻面并弃置一张装备牌，防止此伤害。"],
                "骆统": ["仁政", "锁定技，当一次伤害结算结束后，若此次伤害被减少或防止过，你摸两张牌。"],
                "太史慈": ["天义", "出牌阶段限一次，你可以与一名角色拼点，然后你本阶段根据拼点结果获得对应效果：若你赢，则你使用【杀】的次数上限+1、使用【杀】无距离限制、使用【杀】的目标数上限+1，否则你不能使用【杀】。"],
                "诸葛诞": ["举义", "觉醒技，准备阶段，若你已受伤且体力上限大于全场角色数，你将手牌摸至体力上限，获得技能'崩坏'和'威重'。"],
                "张鲁": ["义舍", "结束阶段，若你没有'米'，你可以摸两张牌，然后将两张牌置于你的武将牌上，称为'米'。"],
                "关羽": ["义绝", "出牌阶段限一次，你可以弃置一张牌，令一名其他角色展示一张手牌。若此牌为红色，你获得此牌且你可以令其回复1点体力；若此牌为黑色，本回合：其所有非锁定技失效且不能使用或打出手牌、你使用红桃【杀】对其造成的伤害+1。"],
                "胡班": ["崇义", "当一名角色于其出牌阶段内使用第一张牌时，若此牌为【杀】，你可以令其摸两张牌且其本阶段使用【杀】的次数上限+1；一名角色的出牌阶段结束时，若其本阶段使用的最后一张牌为【杀】，你可以从弃牌堆中获得此【杀】并令该角色本回合的手牌上限+1。"],
                "谋张秀": ["豪义", "结束阶段，你可以获得本回合进入弃牌堆的未造成伤害的伤害牌，然后你可以将这些牌分配给其他角色。"],
                "蒋钦": ["尚义", "出牌阶段限一次，你可以令一名其他角色观看你的手牌，然后你观看其手牌并可以弃置其中任意张花色不同的黑色牌。"],
                "陶谦": ["义襄", "锁定技，其他角色的出牌阶段内：1.其使用的第一张牌对你造成伤害时，此伤害-1；2.其使用第二张牌时，若此牌为黑色，对你无效。"],
                "张奂": ["义拒", "锁定技，其他角色使用牌指定你为唯一目标后，你弃置一张牌。"],
                "公孙瓒": ["义从", "锁定技，你计算与其他角色的距离-1；若你已损失的体力值不小于2，其他角色计算与你的距离+1。"],
                "张嫙": ["同礼", "出牌阶段，当你使用牌指定目标后，若你本阶段使用过X张牌（X为你手牌中的花色数），你可以令此牌效果额外执行X次。"],
                "孔融": ["礼让", "当你的牌因弃置而置入弃牌堆时，你可以将其中的任意张牌交给其他角色。"],
                "陆绩": ["遗礼", "出牌阶段开始时，你可以失去1点体力或移去1个'橘'，令一名其他角色获得1个'橘'。"],
                "士燮": ["礼下", "锁定技，其他角色的结束阶段，若你不在其攻击范围内，你选择一项：1.摸一张牌；2.令其摸两张牌。选择完成后，其他角色计算与你的距离-1。"],
                "曹嵩": ["礼赂", "摸牌阶段，你可以改为将手牌摸至体力上限（至多摸至五张），然后交给一名其他角色至少一张手牌。若你给出的牌数大于你上一次以此法给出的牌数，你加1点体力上限并回复1点体力。"],
                "黄月英": ["集智", "当你使用一张非转化的锦囊牌时，你可以摸一张牌。若此牌为基本牌，你可以弃置此牌，令你本回合的手牌上限+1。"],
                "陈宫": ["智迟", "锁定技，当你于回合外受到伤害后，本回合【杀】和普通锦囊牌对你无效。"],
                "孟优": ["蛮智", "准备阶段或结束阶段，若你此时的体力值与你本回合准备阶段的体力值相同，你可以选择一名其他角色并选择本回合未选择过的一项：1.令其交给你两张牌，然后其视为使用一张无距离限制的【杀】；2.获得其区域内的至多两张牌，然后交给其等量的牌并摸一张牌。"],
                "甘夫人": ["神智", "准备阶段，若你的手牌数大于体力值，你可以弃置一张手牌，回复1点体力。"],
                "荀攸": ["智愚", "当你受到伤害后，你可以摸一张牌，展示所有手牌，然后令伤害来源弃置一张手牌。若你的手牌颜色均相同，你获得弃置的牌且'奇策'的发动次数上限+1直到你的回合结束。"],
                "钟毓": ["智对", "你使用牌时，若与上一张被使用的牌牌名字数与类型皆相同，你可选择一项：\n1.摸两张牌；\n2.使此牌不计入次数限制。\n若皆不同此技能本回合失效。"],
                "张恭": ["遣信", "出牌阶段限一次，若牌堆中没有'信'，你可以选择一名角色并将任意张手牌明置于牌堆中X倍数的位置（X为存活角色数），称为'信'。该角色的弃牌阶段开始时，若其手牌中有本回合获得的'信'，其选择一项：1.令你将手牌摸至四张；2.本回合的手牌上限-2。"]
            }
        };

        // 用户数据
        const userData = {
            currentPool: "",
            selectedOptions: 0,
            removedCards: [],
            characters: [],
            customSkills: {},
            executedActions: []
        };

        // 当前操作状态
        let currentState = {
            selectedCard: "",
            selectedOptionsList: [],
            targetCharacter: "",
            selectedSkill: null,
            randomSkills: [],
            isExecutingOption1: false,
            viewingSkill: null // 新增：用于标记查看技能的状态
        };

        // 页面切换
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // 选择技能池
        function selectPool(pool) {
            userData.currentPool = pool;
            showPage('page2');
            updateCardButtons();
            renderCharacters();
            renderExecutedActions();
        }

        // 选择卡牌
        function selectCard(card) {
            if (userData.removedCards.includes(card)) {
                alert('此卡牌已被移除！');
                return;
            }
            
            currentState.selectedCard = card;
            currentState.selectedOptionsList = [];
            currentState.isExecutingOption1 = false;
            currentState.viewingSkill = null;
            
            document.getElementById('selectedCardText').textContent = card;
            document.getElementById('xValue').textContent = Math.min(userData.selectedOptions, 4);
            
            updateOptionButtons();
            document.getElementById('optionsModal').classList.add('active');
            updateSelectedOptions();
            document.getElementById('selectionStatus').textContent = '请选择2个不重复的选项（已选择0个）';
            document.getElementById('executedActionsInModal').innerHTML = '';
        }

        // 更新选项按钮状态
        function updateOptionButtons() {
            const option1Btn = document.getElementById('option1Btn');
            const option2Btn = document.getElementById('option2Btn');
            const option3Btn = document.getElementById('option3Btn');
            
            const isOption1Selected = currentState.selectedOptionsList.includes('选项1');
            const isOption2Selected = currentState.selectedOptionsList.includes('选项2');
            const isOption3Selected = currentState.selectedOptionsList.includes('选项3');
            
            option1Btn.disabled = isOption1Selected;
            option2Btn.disabled = isOption2Selected;
            option3Btn.disabled = isOption3Selected;
            
            const allCardsRemoved = ['杀', '闪', '桃', '酒'].every(c => userData.removedCards.includes(c));
            if (allCardsRemoved) {
                option3Btn.disabled = true;
            }
        }

        // 选择选项
        function selectOption(option) {
            const optionStr = `选项${option}`;
            if (currentState.selectedOptionsList.includes(optionStr)) {
                alert('不能重复选择同一个选项！');
                return;
            }
            
            executeOptionAction(option);
            currentState.selectedOptionsList.push(optionStr);
            updateSelectedOptions();
            updateOptionButtons();
            document.getElementById('xValue').textContent = Math.min(userData.selectedOptions, 4);
            
            const selectedCount = currentState.selectedOptionsList.length;
            document.getElementById('selectionStatus').textContent = 
                `请选择2个不重复的选项（已选择${selectedCount}个）`;
            
            if (currentState.selectedOptionsList.length >= 2 && !currentState.isExecutingOption1) {
                setTimeout(() => {
                    completeSelection();
                }, 500);
            }
        }

        // 执行选项对应的操作
        function executeOptionAction(option) {
            let actionDescription = '';
            
            switch(option) {
                case 1:
                    actionDescription = `[选项1] 防止了【${currentState.selectedCard}】的伤害，正在抽取技能...`;
                    currentState.isExecutingOption1 = true;
                    setTimeout(() => {
                        document.getElementById('characterName').value = '';
                        document.getElementById('characterModal').classList.add('active');
                    }, 100);
                    break;
                    
                case 2:
                    const xValue = Math.min(userData.selectedOptions, 4);
                    actionDescription = `[选项2] 减1点体力上限并摸${xValue}张牌`;
                    break;
                    
                case 3:
                    if (!userData.removedCards.includes(currentState.selectedCard)) {
                        userData.removedCards.push(currentState.selectedCard);
                    }
                    userData.selectedOptions = Math.min(userData.selectedOptions + 1, 4);
                    updateCardButtons();
                    actionDescription = `[选项3] 移除了【${currentState.selectedCard}】卡牌`;
                    break;
            }
            
            if (actionDescription) {
                userData.executedActions.push({
                    card: currentState.selectedCard,
                    option: option,
                    description: actionDescription,
                    timestamp: new Date().toLocaleTimeString()
                });
                
                const executedActionsDiv = document.getElementById('executedActionsInModal');
                const actionDiv = document.createElement('div');
                actionDiv.style.cssText = 'margin: 5px 0; padding: 8px; background: #fff; border-radius: 6px; border-left: 4px solid #ffc107;';
                actionDiv.textContent = `✓ ${actionDescription}`;
                executedActionsDiv.appendChild(actionDiv);
                
                renderExecutedActions();
            }
        }

        // 完成选择
        function completeSelection() {
            userData.executedActions.push({
                card: currentState.selectedCard,
                description: `【${currentState.selectedCard}】卡牌操作完成`,
                timestamp: new Date().toLocaleTimeString()
            });
            renderExecutedActions();
            
            document.getElementById('optionsModal').classList.remove('active');
            currentState.selectedOptionsList = [];
            currentState.selectedSkill = null;
            currentState.isExecutingOption1 = false;
            
            alert(`【${currentState.selectedCard}】卡牌操作完成！`);
        }

        // 更新已选择的选项显示
        function updateSelectedOptions() {
            const listElement = document.getElementById('selectedOptionsList');
            listElement.innerHTML = currentState.selectedOptionsList.map(opt => 
                `<div>${opt}</div>`
            ).join('');
        }

        // 更新卡牌按钮状态
        function updateCardButtons() {
            const cards = ['杀', '闪', '桃', '酒'];
            const cardButtons = document.querySelectorAll('.card-btn');
            
            cardButtons.forEach((btn, index) => {
                const card = cards[index];
                btn.disabled = userData.removedCards.includes(card);
            });
        }

        // 渲染已执行的操作
        function renderExecutedActions() {
            const container = document.getElementById('executedActions');
            if (userData.executedActions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666;">暂无执行操作</div>';
                return;
            }
            
            const recentActions = userData.executedActions.slice(-5);
            container.innerHTML = recentActions.map(action => 
                `<div>${action.timestamp} - ${action.description}</div>`
            ).join('');
        }

        // 确认角色名
        function confirmCharacter() {
            const characterName = document.getElementById('characterName').value.trim();
            if (!characterName) {
                alert('请输入角色名！');
                return;
            }
            
            currentState.targetCharacter = characterName;
            document.getElementById('characterModal').classList.remove('active');
            showSkillSelection();
        }

        // 关闭角色名弹窗
        function closeCharacterModal() {
            document.getElementById('characterModal').classList.remove('active');
            document.getElementById('characterName').value = '';
            
            const index = currentState.selectedOptionsList.indexOf('选项1');
            if (index > -1) {
                currentState.selectedOptionsList.splice(index, 1);
                updateSelectedOptions();
                updateOptionButtons();
                currentState.isExecutingOption1 = false;
                
                if (currentState.selectedOptionsList.length >= 2) {
                    setTimeout(() => {
                        completeSelection();
                    }, 100);
                }
            }
        }

        // 关闭选项弹窗
        function closeOptionsModal() {
            document.getElementById('optionsModal').classList.remove('active');
            currentState.selectedOptionsList = [];
            currentState.isExecutingOption1 = false;
        }

        // 关闭技能选择弹窗
        function closeSkillsModal() {
            document.getElementById('skillsModal').classList.remove('active');
        }

        // 显示技能选择
        function showSkillSelection() {
            const pool = skillPools[userData.currentPool];
            if (!pool) {
                alert('技能池数据错误！');
                return;
            }
            
            const allSkills = {...pool};
            if (userData.customSkills[userData.currentPool]) {
                Object.assign(allSkills, userData.customSkills[userData.currentPool]);
            }
            
            const availableSkills = [];
            const characterSkills = userData.characters.find(c => c.character === currentState.targetCharacter)?.skills || [];
            
            Object.keys(allSkills).forEach(character => {
                const skillData = allSkills[character];
                if (skillData && skillData.length >= 2) {
                    const skillName = skillData[0];
                    const skillDesc = skillData[1];
                    
                    if (!characterSkills.some(s => s.character === character && s.skillName === skillName)) {
                        availableSkills.push({
                            character: character,
                            skillName: skillName,
                            description: skillDesc
                        });
                    }
                }
            });
            
            if (availableSkills.length > 0) {
                currentState.randomSkills = [];
                const shuffled = [...availableSkills].sort(() => 0.5 - Math.random());
                currentState.randomSkills = shuffled.slice(0, Math.min(3, shuffled.length));
                
                document.getElementById('targetCharacter').textContent = currentState.targetCharacter;
                const choicesContainer = document.getElementById('skillChoices');
                choicesContainer.innerHTML = currentState.randomSkills.map((skill, index) => 
                    `<div class="skill-choice" onclick="showSkillSelectDetail(${index})">
                        ${skill.character}：${skill.skillName}
                    </div>`
                ).join('');
                
                document.getElementById('skillsModal').classList.add('active');
            } else {
                alert('没有可用的技能！');
                const index = currentState.selectedOptionsList.indexOf('选项1');
                if (index > -1) {
                    currentState.selectedOptionsList.splice(index, 1);
                    updateSelectedOptions();
                    updateOptionButtons();
                    currentState.isExecutingOption1 = false;
                    
                    if (currentState.selectedOptionsList.length >= 2) {
                        setTimeout(() => {
                            completeSelection();
                        }, 100);
                    }
                }
            }
        }

        // 显示技能选择详情（选择技能时用）
        function showSkillSelectDetail(index) {
            currentState.selectedSkill = currentState.randomSkills[index];
            currentState.viewingSkill = false; // 标记为选择技能，不是查看
            
            document.getElementById('skillSelectTitle').textContent = 
                `${currentState.selectedSkill.character}：${currentState.selectedSkill.skillName}`;
            document.getElementById('skillSelectDescription').textContent = currentState.selectedSkill.description;
            
            document.getElementById('skillsModal').classList.remove('active');
            document.getElementById('skillSelectDetailModal').classList.add('active');
        }

        // 关闭技能选择详情弹窗
        function closeSkillSelectDetail() {
            document.getElementById('skillSelectDetailModal').classList.remove('active');
            document.getElementById('skillsModal').classList.add('active');
        }

        // 确认选择技能
        function confirmSkill() {
            if (!currentState.selectedSkill) return;
            
            let character = userData.characters.find(c => c.character === currentState.targetCharacter);
            if (!character) {
                character = {
                    character: currentState.targetCharacter,
                    skills: []
                };
                userData.characters.push(character);
            }
            
            character.skills.push({
                character: currentState.selectedSkill.character,
                skillName: currentState.selectedSkill.skillName,
                description: currentState.selectedSkill.description
            });
            
            userData.executedActions.push({
                card: currentState.selectedCard,
                description: `[选项1完成] 为【${currentState.targetCharacter}】赋予了技能：${currentState.selectedSkill.character}：${currentState.selectedSkill.skillName}`,
                timestamp: new Date().toLocaleTimeString()
            });
            renderExecutedActions();
            
            document.getElementById('skillSelectDetailModal').classList.remove('active');
            renderCharacters();
            
            currentState.isExecutingOption1 = false;
            
            if (currentState.selectedOptionsList.length >= 2) {
                setTimeout(() => {
                    completeSelection();
                }, 100);
            } else {
                document.getElementById('optionsModal').classList.add('active');
                updateOptionButtons();
            }
        }

        // 显示技能详情（查看已获得技能时用）
        function showSkillInfo(characterName, skillName, skillDescription) {
            // 设置查看状态
            currentState.viewingSkill = true;
            
            document.getElementById('skillTitle').textContent = 
                `${characterName}：${skillName}`;
            document.getElementById('skillDescription').textContent = skillDescription;
            
            // 显示查看用的弹窗，隐藏确认按钮
            document.getElementById('skillDetailModal').classList.add('active');
        }

        // 关闭技能详情弹窗（查看用）
        function closeSkillDetailModal() {
            document.getElementById('skillDetailModal').classList.remove('active');
        }

        // 渲染角色列表
        function renderCharacters() {
            const container = document.getElementById('charactersList');
            if (userData.characters.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">暂无获得角色</p>';
                return;
            }
            
            container.innerHTML = userData.characters.map(character => `
                <div class="character">
                    <h3>${character.character}</h3>
                    <div>
                        ${character.skills.map(skill => `
                            <span class="skill" onclick="showSkillInfo('${skill.character}', '${skill.skillName}', '${skill.description.replace(/'/g, "\\'")}')">
                                ${skill.character}：${skill.skillName}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // 打开技能池管理
        function openPoolManage() {
            if (!userData.currentPool) {
                alert('请先选择技能池！');
                return;
            }
            
            document.getElementById('currentPoolName').textContent = userData.currentPool;
            renderAllSkills();
            document.getElementById('poolManageModal').classList.add('active');
        }

        // 渲染所有技能
        function renderAllSkills() {
            const pool = skillPools[userData.currentPool];
            const customPool = userData.customSkills[userData.currentPool] || {};
            const allSkills = {...pool, ...customPool};
            
            const container = document.getElementById('allSkillsList');
            container.innerHTML = Object.keys(allSkills).map(character => {
                const skillData = allSkills[character];
                if (skillData && skillData.length >= 2) {
                    return `
                        <div class="skill-item">
                            ${character}：${skillData[0]} / ${skillData[1]}
                        </div>
                    `;
                }
                return '';
            }).join('');
        }

        // 添加自定义技能
        function addCustomSkill() {
            const input = document.getElementById('newSkillInput').value.trim();
            if (!input) {
                alert('请输入技能！');
                return;
            }
            
            const parts = input.split('/');
            if (parts.length < 2) {
                alert('格式错误！请使用：角色名：技能名/技能描述');
                return;
            }
            
            const rolePart = parts[0].trim();
            const roleName = rolePart.split('：')[0]?.trim();
            const skillName = rolePart.split('：')[1]?.trim() || '';
            const skillDesc = parts.slice(1).join('/').trim();
            
            if (!roleName || !skillName) {
                alert('格式错误！请使用：角色名：技能名/技能描述');
                return;
            }
            
            if (!userData.customSkills[userData.currentPool]) {
                userData.customSkills[userData.currentPool] = {};
            }
            
            userData.customSkills[userData.currentPool][roleName] = [skillName, skillDesc];
            
            document.getElementById('newSkillInput').value = '';
            renderAllSkills();
            alert('技能添加成功！');
        }

        // 关闭技能池管理
        function closePoolManage() {
            document.getElementById('poolManageModal').classList.remove('active');
            document.getElementById('newSkillInput').value = '';
        }

        // 初始化
        function init() {
            renderCharacters();
            renderExecutedActions();
            
            document.addEventListener('touchstart', function() {}, {passive: true});
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>